name: éƒ¨ç½²

on:
  push:
    branches: [main]
    paths-ignore:
      - '.github/**'
      - '*.md'
      - '.gitignore'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: ç¼–è¯‘ Zig å›¾ç‰‡å¤„ç†å™¨
        run: |
          cd img-processor
          zig build -Doptimize=ReleaseFast -Dtarget=x86_64-linux-gnu
          cp zig-out/bin/img-processor ../internal/services/img-processor-bin

      - name: å®‰è£… Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: go.sum

      - name: ä¸‹è½½ä¾èµ–
        run: go mod download

      - name: ç¼–è¯‘åç«¯
        run: GOOS=linux GOARCH=amd64 go build -o server ./cmd/server

      - name: ç¼–è¯‘å‰ç«¯
        run: go run ./cmd/build

      - name: æ‰“åŒ…æ–‡ä»¶
        run: |
          TIMESTAMP=$(TZ='Asia/Shanghai' date +%Y%m%d_%H%M%S)
          FILENAME="deploy_${TIMESTAMP}.tar.gz"
          echo "DEPLOY_FILENAME=$FILENAME" >> $GITHUB_ENV
          tar -czvf "$FILENAME" server dist/

      - name: ä¸Šä¼ åˆ° R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT }}
        run: |
          pip install awscli
          
          # ä¸Šä¼ æ–°æ–‡ä»¶
          aws s3 cp ${{ env.DEPLOY_FILENAME }} s3://nebula-deploy/${{ env.DEPLOY_FILENAME }} --endpoint-url $AWS_ENDPOINT_URL
          
          # åŒæ—¶ä¿ç•™ä¸€ä¸ªå›ºå®šåç§°çš„æœ€æ–°ç‰ˆæœ¬ï¼ˆä¾› webhook ä¸‹è½½ï¼‰
          aws s3 cp ${{ env.DEPLOY_FILENAME }} s3://nebula-deploy/deploy.tar.gz --endpoint-url $AWS_ENDPOINT_URL
          
          # åˆ é™¤æ—§æ–‡ä»¶ï¼Œåªä¿ç•™æœ€è¿‘ 5 ä¸ª
          aws s3 ls s3://nebula-deploy/ --endpoint-url $AWS_ENDPOINT_URL | grep "deploy_" | sort -r | tail -n +6 | awk '{print $4}' | while read file; do
            aws s3 rm s3://nebula-deploy/$file --endpoint-url $AWS_ENDPOINT_URL
          done

      - name: è§¦å‘éƒ¨ç½²å¹¶ç­‰å¾…å®Œæˆ
        run: |
          WEBHOOK_URL="https://linux-webhook.nebulastudios.dpdns.org"
          
          # è§¦å‘éƒ¨ç½²ï¼Œè·å–éƒ¨ç½² ID
          echo "ğŸš€ è§¦å‘éƒ¨ç½²..."
          RESPONSE=$(curl -s -X POST "$WEBHOOK_URL/deploy" \
            -H "Content-Type: application/json" \
            -H "X-Deploy-Token: ${{ secrets.DEPLOY_TOKEN }}" \
            -d '{"version": "${{ github.sha }}"}')
          
          DEPLOY_ID=$(echo "$RESPONSE" | grep -o '"deployId":"[^"]*"' | cut -d'"' -f4)
          
          if [ -z "$DEPLOY_ID" ]; then
            echo "âŒ è§¦å‘éƒ¨ç½²å¤±è´¥: $RESPONSE"
            exit 1
          fi
          
          echo "ğŸ“‹ éƒ¨ç½² ID: $DEPLOY_ID"
          
          # è½®è¯¢çŠ¶æ€ï¼Œæœ€å¤šç­‰å¾… 2 åˆ†é’Ÿ
          for i in $(seq 1 24); do
            sleep 5
            STATUS_RESPONSE=$(curl -s "$WEBHOOK_URL/deploy/$DEPLOY_ID")
            STATUS=$(echo "$STATUS_RESPONSE" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
            
            echo "â³ [$i/24] çŠ¶æ€: $STATUS"
            
            if [ "$STATUS" = "success" ]; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
              exit 0
            elif [ "$STATUS" = "failed" ]; then
              echo "âŒ éƒ¨ç½²å¤±è´¥: $STATUS_RESPONSE"
              exit 1
            fi
          done
          
          echo "â° éƒ¨ç½²è¶…æ—¶"
          exit 1
